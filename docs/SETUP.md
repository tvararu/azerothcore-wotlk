# Server Setup

End-to-end guide for setting up the AzerothCore WotLK 3.3.5a server with playerbots fork and extra modules.

## Prerequisites

- Docker and Docker Compose
- [mise](https://mise.jdx.dev/) (`curl https://mise.run | sh`)
- Tailscale (for remote access)
- WoW 3.3.5a client with `realmlist.wtf` pointing to your Tailscale IP

## Fresh Setup

### 1. Install tools and generate encryption key

```bash
mise install                        # Installs age (for secret encryption)
mkdir -p config
age-keygen -o config/secret.key     # Generate project-local encryption key
```

### 2. Set secrets

Passwords are stored age-encrypted in `mise.toml` (safe to commit). The decryption key (`config/secret.key`) is gitignored.

```bash
mise set --age-encrypt --prompt DOCKER_DB_ROOT_PASSWORD   # MySQL root password
mise set --age-encrypt --prompt ADMIN_USERNAME             # Game admin username
mise set --age-encrypt --prompt ADMIN_PASSWORD             # Game admin password (max 16 chars!)
```

### 3. Clone modules and generate config

```bash
mise setup-modules    # Clones all modules (see .mise/tasks/setup-modules for list)
mise init             # Generates docker-compose.override.yml
```

### 4. Build and start

```bash
mise build            # First build compiles from source (~15-30 min)
```

Wait for the worldserver to be ready:

```bash
mise logs             # Watch for "worldserver-daemon) ready...", then Ctrl+C
```

### 5. Seed the database

```bash
mise seed --raw       # Applies module SQL, sets realmlist, creates admin account
```

The `--raw` flag is needed because the account creation writes to the worldserver's stdin. Seed is idempotent — safe to re-run (tracks applied SQL in a `_seed_applied` table per database).

### 6. Restart worldserver

The worldserver caches database tables at startup, so module SQL applied by seed needs a restart to take effect:

```bash
mise restart
```

Wait for ready again, then you're good to log in.

## Day-to-Day

```bash
mise start            # Start server
mise stop             # Stop server
mise restart          # Restart containers (no rebuild)
mise logs             # Tail worldserver logs
mise status           # Container status
mise health           # Verify secrets, modules, Docker, Tailscale, and worldserver
mise cmd '.server info'   # Run any worldserver command via SOAP
mise console          # Interactive worldserver console (Ctrl+P,Ctrl+Q to detach)
mise db               # MySQL shell
```

## Full Reset

When you need a clean slate (new modules, schema changes, etc.):

```bash
mise nuke --raw       # Destroy DB volume (prompts for confirmation)
mise start            # Reimport all SQL from scratch
# Wait for "ready..."
mise seed --raw       # Reapply module SQL + realmlist + admin account
mise restart          # Restart to load new module data
```

No recompile needed — only the database is reset.

## Adding a Module

1. Add the git clone URL to `.mise/tasks/setup-modules`
2. If the module uses the old SQL directory convention (`data/sql/world/` instead of `data/sql/db-world/`), the seed task handles both automatically
3. If the module needs config overrides, update the `init` task to include them in `docker-compose.override.yml`
4. Run: `mise setup-modules && mise build` (recompile needed for new C++ modules)
5. Then nuke + seed to get a clean DB with the new module SQL

## Secrets

Secrets are age-encrypted in `mise.toml` using the key at `config/secret.key`. To rotate:

```bash
mise set --age-encrypt --prompt DOCKER_DB_ROOT_PASSWORD   # Set new value
mise nuke --raw && mise start && mise seed --raw          # Reset with new password
```

The encryption key itself is gitignored. If you lose it, re-generate and re-encrypt all secrets.

## Architecture

```
mise.toml                      # Task definitions + encrypted secrets
.mise/tasks/                   # Complex task scripts
docker-compose.yml             # Base Docker config (tracked in git)
docker-compose.override.yml    # Local overrides (gitignored, generated by mise init)
config/secret.key              # Age decryption key (gitignored)
modules/mod-*/                 # Cloned modules (gitignored, managed by setup-modules)
```
